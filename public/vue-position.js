var data = { "code": "0000", "data": [{ "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 0, "code": "000521", "createtime": "2017-02-10 13:29:03", "freezeposition": 0, "hedgeflag": "1", "id": 168155, "lastupdate": "2017-02-10 13:29:03", "locked": 0, "market": "SZ", "openprice": 7, "position": 500, "positionPrice": 0, "positiontype": 0, "preposition": 500, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 0, "sellqty": 0, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 500 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 0, "code": "603519", "createtime": "2017-02-10 13:29:03", "freezeposition": 0, "hedgeflag": "1", "id": 168154, "lastupdate": "2017-02-10 13:29:03", "locked": 0, "market": "SH", "openprice": 30.07, "position": 100, "positionPrice": 0, "positiontype": 0, "preposition": 100, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 0, "sellqty": 0, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 100 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 0, "code": "002403", "createtime": "2017-02-10 13:29:03", "freezeposition": 0, "hedgeflag": "1", "id": 168153, "lastupdate": "2017-02-10 13:29:03", "locked": 0, "market": "SZ", "openprice": 14.17, "position": 200, "positionPrice": 0, "positiontype": 0, "preposition": 200, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 0, "sellqty": 0, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 200 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": -272, "code": "002473", "createtime": "2017-02-10 13:29:03", "freezeposition": 0, "hedgeflag": "1", "id": 168152, "lastupdate": "2017-02-10 13:29:03", "locked": 0, "market": "SZ", "openprice": 26.94, "position": 0, "positionPrice": 0, "positiontype": 0, "preposition": 100, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 24.22, "sellqty": 100, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 0 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 0, "code": "600060", "createtime": "2017-02-10 13:29:03", "freezeposition": 0, "hedgeflag": "1", "id": 168151, "lastupdate": "2017-02-10 13:29:03", "locked": 0, "market": "SH", "openprice": 17.75, "position": 100, "positionPrice": 0, "positiontype": 0, "preposition": 100, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 0, "sellqty": 0, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 100 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 232, "code": "002677", "createtime": "2017-02-10 13:29:03", "freezeposition": 0, "hedgeflag": "1", "id": 168150, "lastupdate": "2017-02-10 13:29:03", "locked": 0, "market": "SZ", "openprice": 12.13, "position": 0, "positionPrice": 0, "positiontype": 0, "preposition": 200, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 13.29, "sellqty": 200, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 0 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 0, "code": "000921", "createtime": "2017-02-10 13:26:15", "freezeposition": 0, "hedgeflag": "1", "id": 168149, "lastupdate": "2017-02-10 13:26:15", "locked": 0, "market": "SZ", "openprice": 11.44, "position": 300, "positionPrice": 0, "positiontype": 0, "preposition": 300, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 0, "sellqty": 0, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 300 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 0, "code": "000800", "createtime": "2017-02-10 13:25:57", "freezeposition": 0, "hedgeflag": "1", "id": 168148, "lastupdate": "2017-02-10 13:25:57", "locked": 0, "market": "SZ", "openprice": 11.37, "position": 200, "positionPrice": 0, "positiontype": 0, "preposition": 200, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 0, "sellqty": 0, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 200 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 0, "code": "000951", "createtime": "2017-02-10 13:25:57", "freezeposition": 0, "hedgeflag": "1", "id": 168147, "lastupdate": "2017-02-10 13:25:57", "locked": 0, "market": "SZ", "openprice": 15.99, "position": 200, "positionPrice": 0, "positiontype": 0, "preposition": 200, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 0, "sellqty": 0, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 200 }, { "accountid": "110011", "brokerid": "001", "bstype": "B", "ccy": "CNY", "closeprofit": 0, "code": "000757", "createtime": "2017-02-10 13:25:57", "freezeposition": 0, "hedgeflag": "1", "id": 168146, "lastupdate": "2017-02-10 13:25:57", "locked": 0, "market": "SZ", "openprice": 10.31, "position": 300, "positionPrice": 0, "positiontype": 0, "preposition": 300, "price": 0, "profitLoss": 0, "proportion": 0, "sellprice": 0, "sellqty": 0, "shareholderid": "", "strategyid": 1252, "todayposition": 0, "userid": "cqtl001", "ysdposition": 300 }], "msg": "", "msgType": "position", "page": { "begin": 0, "count": true, "currentPage": 1, "currentPageRows": 10, "end": 10, "first": true, "last": false, "length": 10, "totalPage": 3, "totalRows": 24 } };

    function SimpleQuote() {
        var that = this;

        this.nsps = {};
        this.nspsCb = {};
        this.nspsDeferred = {};
        this.refs = {};

        // 所有股票行情信息
        this.quotesInfo = {}; // code为key，当前价为 value
        this.limitUpDown = {};// code为key，是否涨跌停为 value

        // 获取某个股票的行情(gt 方法不可暴露给外部直接使用, 因为gt方法不保证获取所有代码的行情，需要先promise一些股票代码，再返回gt方法供使用)
        // gt 方法增加第二个参数，gtType “获取类型”，不传入则还是之前的默认获取价格, gtType： 1 获取是否涨跌停字段
        var gt = function (code, gtType) {
            code = that.wrapCode(code);
            var r = 0;
            
            if (!gtType) { // 默认是取价格
            	r = that.quotesInfo[code];
            } else {
        		r = that.limitUpDown[code]; // 取是否涨跌停
            }
            
            if (isNaN(r)) {
                r = 0;
                console.error('没有找到该股票(%s)的行情 ，现有处理返回0。 \n 1. 确保使用之前有调用方法订阅该股票  \n 2. 检查行情快照文件中是否有该股票 \n 3. 检查股票代码是否为不存在的代码，排除测试数据的可能', code)
            }
            return r;
        };

        this.wrapCode = function (code) {
        	if (code.indexOf('.') < 0) {
        		console.warn('根据代码补充市场的方法，是属于用户体验提升的方法，仅适用于手动下单，请确保合理使用。')
        		return code + '.' + (/^(6|204)/.test(code) ? 'SH' : 'SZ');
           	}
        	return code;
        };

        // 同一个namespace 只订阅一组股票代码
        this.subcribe = function (nsp, codes, cb) {
            var dfd = $.Deferred(),
            	codes = _(codes).uniq().value(),
                newSubs = [], unSubs = [],
                needSubs = [], needUnsubs = [];

            that.nspsCb[nsp] = cb;
           	that.nspsDeferred[nsp] = dfd;

            if (!that.nsps[nsp]) {
                that.nsps[nsp] = [];
            }

            newSubs = _(codes).difference(that.nsps[nsp]).value();
            unSubs = _(that.nsps[nsp]).difference(codes).value();
            that.nsps[nsp] = codes;

            newSubs.forEach(function (code) {
                that.refs[code] = (that.refs[code] || (needSubs.push(code) && 0)) + 1;
            });

            unSubs.forEach(function (code) {
                that.refs[code] = (that.refs[code] > 1) ? (that.refs[code] - 1) : (needUnsubs.push(code) && 0);
            });

            if (needSubs.length > 0) {
                socket.emit('appendMessage', nsp + ':' + needSubs.join(','));
            } else {
                setTimeout(function() {
            	    dfd.resolve(gt); //没有新订阅的股票，直接resolve
                });
            }
            if (needUnsubs.length > 0) {
                socket.emit('unsubcribe', needUnsubs.join(','));
            }

            return dfd.promise();
        };

        // 批量返回的行情
        this.onBatchMessage = function (msg) {
        	var msgPair = msg.split(':'),
				reqId = msgPair[0],
				priceStr = msgPair[1];
        	
            priceStr.split('|').forEach(function (pairStr) {
                var pair = pairStr.split(',');
                that.quotesInfo[pair[0]] = pair[1];
                that.limitUpDown[pair[0]] =pair[2]; 
            });
            that.nspsDeferred[reqId].resolve(gt);
        };

        //单个推送的行情消息
        this.onMessage = function (msgPair) {
            var pair = msgPair.split(',');
            that.quotesInfo[pair[0]] = pair[1];
            that.limitUpDown[pair[0]] =pair[2];

            for (var nsp in that.nsps) {
                if (that.nsps[nsp].indexOf(pair[0]) >= 0) {
                    that.nspsCb[nsp](pair);
                }
            }
        };
    }

var subCodes = data.data.map(item => item.code + '.' + item.market);
console.log(subCodes)

// vue
var app = new Vue({
    el: '#app',
    data: {
        datas: data.data
    }
});